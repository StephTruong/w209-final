
<!DOCTYPE html>

<style>

/*set the containers for the two charts that make up the table lens.*/
.container_chart1 {
  position: absolute;
  left: 0px;
  top: 150px;
  width: 400px;
}
.container_chart2{
  position: absolute;
  left: 500px;
  top: 150px;
  width: 400px;
}

/*set the container for the hover tooltip.*/
div.tooltip {	
    position: absolute;			
    text-align: center;			
    width: 200px;					
    height: 90px;					
    padding: 2px;				
    font: 12px sans-serif;		
    background: white;	
    border: solid;
    border-width: 1px;	
    border-color: black;	
    border-radius: 5px;			
    pointer-events: none;
    z-index:5;			
}

/*set the container for the strip plots.*/
.container_stripPlot1 {
  position: absolute;
  left: 0px;
  width: 400px;
}
.container_stripPlot2{
  position: absolute;
  left: 500px;
  width: 400px;
}

/*css for the strip plot axis.*/
      .axis path,
      .axis line {
        fill: none;
        stroke: none;
        shape-rendering: crispEdges;
      }
      
      .axis text {
        font-family: sans-serif;
        font-size: 11px;
      }
</style>

<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Physicians' Pharma Relationships</title>
        <script type="text/javascript" src="../d3.js"></script>
    </head>
    <h2> Physicians' Pharma Relationships</h2>
    <body> 

    <!--add the divs for the strip plots above the plot titles. This will allow the two plots to share the title text-->
    <div class="container_stripPlot1" id="strip1">
	</div>
	<div class="container_stripPlot2" id="strip2">
	</div>    
    
    <!--add the divs for the two charts for the table lens and include a title for the plots-->
    <div class="container_chart1" id="chart1">
    	<h4 align="center">Money Received from Pharmacuetical Companies</h4>
	</div>
	<div class="container_chart2" id="chart2">
		<h4 align="center">Medicare Prescriptions Written - 2013</h4>
	</div>    
        <script type="text/javascript">	
        	//variables for doctor name and physician ID
        	var Doctor_Name = "Dr. John Smith"
        	var Physician_ID = 13444

        	//set variables for charts
			var w = 400;
			var h = 600;
			var barPadding = 1;
			var barHeight = 27
			var Main_bar_x_Scale_Start = 60
			var padding = 40;
			var barColor = "#62b5d1"

			//svg for the two charts that make up the table lens
			var svg_chart1 = d3.select("#chart1")
			.append("svg")
			.attr("width",w)
			.attr("height",h);

			var svg_chart2 = d3.select("#chart2")
			.append("svg")
			.attr("width",w)
			.attr("height",h);

			//div for hover tooltip
			var div = d3.select("div").append("div")
			    .attr("class", "tooltip")	
			    .attr("id", "Hover_Graph")			
			    .style("opacity", 0);		

			// var svg_tooltip = d3.select("#Hover_Graph")
			// .append("svg");	

			//load data for main table and create the two charts. 
	        d3.json("http://169.53.15.199:20900/mainTable/"+Physician_ID, function(data) {
				jsn_Main_Table_Lens_Data = data.data
				dataset = jsn_Main_Table_Lens_Data.map(function(a) {return [a.RxCnt,a.PmntCnt,a.Rx];});

				var xScale = d3.scale.linear()
					.domain([0,d3.max(dataset,function(d){return d[1];})])
					.range([Main_bar_x_Scale_Start ,w-120 ]);

				var yScale = d3.scale.linear()
					.domain([0,15])
					.range([0 ,h ]);

				//Create chart 1
				svg_chart1.selectAll("rect")
				   .data(dataset.sort(function(a, b){return b[1] - a[1];}))
				   .enter()
				   .append("rect")
				   .attr("y", function(d, i) {
				   		return yScale(i);
				   })
				   .attr("x", Main_bar_x_Scale_Start)
				   .attr("height", barHeight)
				   .attr("width", function(d) {
				   		return xScale(d[1]);
				   })
				   .attr("fill", d3.rgb(barColor))

				   //add on mouseover pop up functionality
				   .on("mouseover", function(d) {	
				   	bar_Value = d[2] //since we are using d again, we need to convert the orginal d to a new variable 

				   	//get coordinates of the mouse to place tooltip next to cursor
				   	var x_cord = d3.event.pageX;
				   	var y_cord = d3.event.pageY;
					
					//load in hover data
				    d3.json("http://169.53.15.199:20900/hoverTable/"+Physician_ID, function(data) {
						dataset= data.data
						jsn_HoverData = dataset.map(function(a) {return [a.Rx,a.PmntType,a.PmntCnt];});

						//need to determine the indexes for d.Rx in jsn_HoverData. Match the drug with a loop and return matching index
						var match_index = []
						var num_matches = 0
						var Matching_Array_Slice = []
						for (i = 0; i < jsn_HoverData.length; i++) { 
	    					if (bar_Value == jsn_HoverData[i][0]){
	    						console.log(bar_Value + " = " + jsn_HoverData[i][0])
	    						match_index[num_matches] = i
	    						Matching_Array_Slice[num_matches] = jsn_HoverData[i]
	    						num_matches++;}
						}

			            div.transition()		
			                .duration(200)		
			                .style("opacity", .9)

			            var Drug_Name = Matching_Array_Slice[0][0]

			            div.html("Drug: "+ Drug_Name + "<br/><font size=\"1\">Nature of Payments</font><br/>")	
			            	.style("left", (x_cord) + "px")		
			                .style("top", (y_cord-40) + "px")
					
					    Bar_x_Scale_Start = 60

						var xScale_hover = d3.scale.linear()
							.domain([0,d3.max(Matching_Array_Slice,function(d){return d[2];})])
							.range([Bar_x_Scale_Start ,100 ]);

						var yScale_hover = d3.scale.linear()
							.domain([0,6])
							.range([5 ,90]); //reverse to y scale goes from bottom to top

			            //create variable to append svg objects to tooltip 	
			            var div_svg = div.append("svg")
				           .attr("width",200)
				           .attr("height",100)

				        //append bars   	
						div_svg.selectAll("svg")
						   .data(Matching_Array_Slice)
						   .enter()
						   .append("rect")
						   .attr("y", function(d, i) {
						   		return yScale_hover(i);
						   })
						   .attr("x", xScale_hover(0))
						   .attr("height", 10)
						   .attr("width",  function(d) { console.log(d)
						   		return xScale_hover(d[2]);
						   })
						   .attr("fill", d3.rgb(barColor));

						//append axis labels
			            div_svg.selectAll("svg")
						    .data(Matching_Array_Slice)
							.enter()
							.append("text")
							.text(function(d) {return d[1]})
							.attr("x", Bar_x_Scale_Start-1)
							.attr("y", function(d, i) {
						   		return yScale_hover(i)+6;
						   	})
							.attr("font-family","sans-serif")
							.attr("font-size", "8px")
							.attr("fill","black")
							.attr("text-anchor","end");

						//append quantitative values		
						div_svg.selectAll("svg")
						    .data(Matching_Array_Slice)
							.enter()
							.append("text")
							.text(function(d) {return "$"+d[2]})
							.attr("x", function(d) {
						   		return xScale_hover(d[2])+Bar_x_Scale_Start+2;
						   	})
							.attr("y", function(d, i) {
						   		return yScale_hover(i)+6;
						   	})
							.attr("font-family","sans-serif")
							.attr("font-size", "8px")
							.attr("fill","black");			                	
		            })	
					})

					
		        	.on("mouseout", function(d) {		
		            div.transition()
		              	.style("opacity", 0)

		            div.selectAll("svg").remove();	//remove the created svg's in the tooltop
		        	});
				
				var xScale_chart2 = d3.scale.linear()
					.domain([0,d3.max(dataset,function(d){return d[0];})])
					.range([Main_bar_x_Scale_Start ,w-120 ]);


				//Create chart 2
				svg_chart2.selectAll("rect")
				   .data(dataset.sort(function(a, b){return b[1] - a[1];}))
				   .enter()
				   .append("rect")
				   .attr("y", function(d, i) {
				   		return yScale(i);
				   })
				   .attr("x", Main_bar_x_Scale_Start)
				   .attr("height", barHeight)
				   .attr("width", function(d) {
				   		return xScale_chart2(d[0]);
				   })
				   .attr("fill", d3.rgb(barColor));


				//Add Labels chart 1
				svg_chart1.selectAll("text")
					.data(dataset.sort(function(a, b){return b[1] - a[1];}))
					.enter()
					.append("text")
					.text(function(d) {return d[2]})
					.attr("x", Main_bar_x_Scale_Start -4)
					.attr("y", function(d, i) {
				   		return yScale(i)+barHeight/2+5;
				   	})
					.attr("font-family","sans-serif")
					.attr("font-size", "15px")
					.attr("fill","black")
					.attr("text-anchor","end");

				//Add Labels chart 2
				svg_chart2.selectAll("text")
					.data(dataset.sort(function(a, b){return b[1] - a[1];}))
					.enter()
					.append("text")
					.text(function(d) {return d[2]})
					.attr("x", Main_bar_x_Scale_Start -4)
					.attr("y", function(d, i) {
				   		return yScale(i)+barHeight/2+5;
				   	})
					.attr("font-family","sans-serif")
					.attr("font-size", "15px")
					.attr("fill","black")
					.attr("text-anchor","end");

				//Add numeric labels chart 1
				svg_chart1.selectAll('svg')
					.data(dataset.sort(function(a, b){return b[1] - a[1];}))
					.enter()
					.append("text")
					.text(function(d) {return "$"+ d[1]})
					.attr("x", function(d) {return  xScale(d[1])+Main_bar_x_Scale_Start+2;})
					.attr("y", function(d, i) {
				   		return yScale(i)+barHeight/2+5;
				   	})
					.attr("font-family","sans-serif")
					.attr("font-size", "13px")
					.attr("fill","black");

				//Add numeric labels chart 2
				svg_chart2.selectAll('svg')
					.data(dataset.sort(function(a, b){return b[1] - a[1];}))
					.enter()
					.append("text")
					.text(function(d) {return d[0];})
					.attr("x", function(d) {return xScale_chart2(d[0])+Main_bar_x_Scale_Start+2;})
					.attr("y", function(d, i) {
				   		return yScale(i)+barHeight/2+5;
				   	})
					.attr("font-family","sans-serif")
					.attr("font-size", "13px")
					.attr("fill","black")
					.attr("text-anchor","start");
				});
	  
////////////////////////////////
//code for strip plots
////////////////////////////////

	  var strip_plot_height = 100
	  var dataset = [];
      var numDataPoints = 500;
      var padding = 10
      var opacity= .1;
      var xRange = Math.random() * 1000;
      var Strip_Circle_r = 4
    //  console.log("xRange: "+xRange);

      for (var i = 0; i < numDataPoints; i++) {
          var newNumber1 = Math.floor(Math.random() * xRange);
          dataset.push([newNumber1]);
        //  console.log(newNumber1);
        }

      //generate a datapoint to mark with a triangle
      var selData= [Math.floor(Math.random() * xRange)];
      console.log("selection:"+selData);

      
      //calculate percentile of value
      var sorted_dataset =  dataset.sort(function(a, b){return a-b}) 
      var Num_Values = dataset.length
      var Num_Greater_Than = 0
      for (var i = 0; i < Num_Values; i++) {if(sorted_dataset[i]==selData[0]){Num_Greater_Than =i;}}      
      var percentile = Num_Greater_Than/Num_Values


      //scale 
      var xScale = d3.scale.linear()
                     .domain([0, d3.max(dataset, function(d) { return parseInt(d); })])
                     .range([0+padding*2, w-padding*2]);

      //Define X axis
      var xAxis = d3.svg.axis()
                .scale(xScale)
                .orient("bottom")
                .tickValues([d3.min(dataset, function(d) { return parseInt(d); }),d3.max(dataset, function(d) { return parseInt(d); })]);


      //define separate svg for the strip plots           
      var svg_strip1 = d3.select("#strip1")
      .append("svg")
      .attr("width",w)
      .attr("height",strip_plot_height);
      
      var svg_strip2 = d3.select("#strip2")
      .append("svg")
      .attr("width",w)
      .attr("height",strip_plot_height);



      svg_strip1.selectAll("circle")
         .data(dataset)
         .enter()
         .append("circle")
         .attr("cx", function(d) {
            return xScale(d);
         })
         .attr("cy", 70)
         .attr("r", Strip_Circle_r)
         .style({stroke: "#62b5d1", "stroke-width": "2px", fill:"#62b5d1", "opacity":opacity});


      svg_strip1.selectAll("circleFocus")
         .data(selData)
         .enter()
         .append("circle")
         .attr("cx", function(d) {
            return xScale(d);
         })
         .attr("cy", 70)
         .attr("r", Strip_Circle_r)
         .style({stroke: "red", "stroke-width": "2px",fill:"red"});

      //create box for percentiles.
      var percentile_box_width = 60 
      var percentile_box_height = 30 
      svg_strip1.selectAll("rect")
         .data(selData)
         .enter()
         .append("rect")
         .attr("width", percentile_box_width)
         .attr("height", percentile_box_height)
         .attr("x", function(d) {
            return xScale(d)-percentile_box_width/2;
         })
         .attr("y", 30)
         .style({stroke: "red", "stroke-width": "1px",fill:"white"});


        //Create X axis
      svg_strip1.append("g")
        .attr("class", "axis")
        .attr("transform", "translate("+0+"," + 70 + ")")
        .call(xAxis);
	

      //Create second strip plot. All the same code as above currently 
     svg_strip2.selectAll("circle")
         .data(dataset)
         .enter()
         .append("circle")
         .attr("cx", function(d) {
            return xScale(d);
         })
         .attr("cy", 70)
         .attr("r", Strip_Circle_r)
         .style({stroke: "#62b5d1", "stroke-width": "2px", fill:"#62b5d1", "opacity":opacity});


      svg_strip2.selectAll("circleFocus")
         .data(selData)
         .enter()
         .append("circle")
         .attr("cx", function(d) {
            return xScale(d);
         })
         .attr("cy", 70)
         .attr("r", Strip_Circle_r)
         .style({stroke: "red", "stroke-width": "2px",fill:"red"});


        //Create X axis
      svg_strip2.append("g")
        .attr("class", "axis")
        .attr("transform", "translate("+0+"," + 70 + ")")
        .call(xAxis);
      
      svg_strip2.selectAll("rect")
         .data(selData)
         .enter()
         .append("rect")
         .attr("width", percentile_box_width)
         .attr("height", percentile_box_height)
         .attr("x", function(d) {
            return xScale(d)-percentile_box_width/2;
         })
         .attr("y", 30)
         .style({stroke: "red", "stroke-width": "1px",fill:"white"});

		</script>


    </body>

</html>